{% extends "admin/base.html" %}

{% block title %}Projects{% endblock %}

{% block extra_head %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
    /* Quill editor styling to match admin dashboard */
    .ql-toolbar.ql-snow {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
        border-color: #e5e7eb;
        background: #f7fafc;
    }
    .ql-container.ql-snow {
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
        border-color: #e5e7eb;
        font-family: inherit;
    }
    .ql-editor {
        min-height: 150px;
        font-size: 1rem;
    }
    .ql-editor.ql-blank::before {
        color: #9ca3af;
        font-style: normal;
    }
</style>
{% endblock %}

{% block content %}
<div class="md:mt-0 mt-16">
    <div class="fade-in mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold text-charcoal">Projects</h1>
            <p class="text-gray-600 mt-2">Manage your portfolio projects</p>
        </div>
        <button onclick="openProjectModal()" class="flex items-center gap-2 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>Add Project</span>
        </button>
    </div>

    <!-- Projects Table -->
    <div class="fade-in bg-white rounded-2xl shadow-sm overflow-hidden">
        <div id="projects-table" class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-light-grey">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Title</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Slug</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Status</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Featured</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Date</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Actions</th>
                    </tr>
                </thead>
                <tbody id="projects-list">
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">Loading projects...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div id="project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-charcoal" id="modal-title">Add Project</h2>
                <button onclick="closeProjectModal()" class="text-gray-500 hover:text-charcoal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="project-form" class="space-y-6">
                <input type="hidden" id="project-id">

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Client</label>
                    <select id="client-id" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                        <option value="">No client (personal project)</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">Link this project to a client</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Title *</label>
                    <input type="text" id="title" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Slug *</label>
                    <input type="text" id="slug" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                    <p class="text-sm text-gray-500 mt-1">URL-friendly identifier (e.g., my-project)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Short Description</label>
                    <input type="text" id="short-description" maxlength="200" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                    <p class="text-sm text-gray-500 mt-1">Brief preview shown on project cards (max 200 characters)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Description *</label>
                    <div id="description-editor" style="height: 200px;" class="bg-white border border-gray-200 rounded-xl"></div>
                    <input type="hidden" id="description" required>
                    <p class="text-sm text-gray-500 mt-1">Full description with rich text formatting</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Tech Stack</label>
                    <input type="text" id="tech-stack" placeholder="Python, FastAPI, PostgreSQL (comma-separated)" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                </div>

                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Project URL</label>
                    <input type="url" id="project-url" placeholder="https://example.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                </div>

                <!-- Media Upload Section -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-charcoal mb-4">Project Media</h3>

                    <!-- Video Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-charcoal mb-2">Video (optional)</label>
                        <input type="file" id="video-file" accept=".mp4,.webm,.mov" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                        <p class="text-sm text-gray-500 mt-1">Max 50MB. Formats: MP4, WebM, MOV</p>
                        <div id="current-video" class="mt-2 hidden">
                            <p class="text-sm text-gray-600">Current video: <span id="current-video-name"></span></p>
                        </div>
                    </div>

                    <!-- Dynamic Image Uploads -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-medium text-charcoal">Images</label>
                            <button type="button" onclick="addImageUpload()" class="flex items-center gap-2 px-4 py-2 bg-muted-blue text-white rounded-lg text-sm font-medium hover:bg-deep-blue transition">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Add Image</span>
                            </button>
                        </div>
                        <div id="image-uploads-container" class="space-y-3">
                            <!-- Image upload items will be added here dynamically -->
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Max 5MB per image. Formats: JPG, PNG, GIF, WebP, SVG</p>
                    </div>
                </div>

                <!-- Project Metrics Section -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-charcoal mb-4">Project Metrics</h3>
                    <p class="text-sm text-gray-600 mb-4">Add metrics to showcase project achievements (e.g., "6-8 hours saved weekly", "100% paper elimination")</p>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-medium text-charcoal">Metrics</label>
                            <button type="button" onclick="addMetricRow()" class="flex items-center gap-2 px-4 py-2 bg-muted-blue text-white rounded-lg text-sm font-medium hover:bg-deep-blue transition">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Add Metric</span>
                            </button>
                        </div>
                        <div id="metrics-container" class="space-y-3">
                            <!-- Metric items will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <input type="checkbox" id="is-published" class="w-5 h-5 text-muted-blue rounded focus:ring-muted-blue">
                    <label for="is-published" class="text-sm font-medium text-charcoal">Published (visible on public site)</label>
                </div>

                <div class="flex items-center gap-3">
                    <input type="checkbox" id="is-featured" class="w-5 h-5 text-muted-blue rounded focus:ring-muted-blue">
                    <label for="is-featured" class="text-sm font-medium text-charcoal">Featured (display as hero project)</label>
                </div>

                <div id="form-error" class="hidden p-4 bg-red-50 text-red-800 border border-red-200 rounded-xl text-sm"></div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                        Save Project
                    </button>
                    <button type="button" onclick="closeProjectModal()" class="px-6 py-3 border-2 border-gray-200 rounded-xl font-medium hover:border-muted-blue transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let editingProjectId = null;
let quillEditor = null;
let imageUploadCounter = 0;
let existingMediaToDelete = [];
let metricCounter = 0;
let existingMetricsToDelete = [];

// Initialize Quill editor
document.addEventListener('DOMContentLoaded', function() {
    quillEditor = new Quill('#description-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Enter project description...'
    });

    // Update hidden input when editor content changes
    quillEditor.on('text-change', function() {
        document.getElementById('description').value = quillEditor.root.innerHTML;
    });
});

// Add a new image upload field
function addImageUpload(existingMedia = null) {
    const container = document.getElementById('image-uploads-container');
    const uploadId = `image-upload-${imageUploadCounter++}`;

    const uploadItem = document.createElement('div');
    uploadItem.className = 'border border-gray-200 rounded-xl p-4 bg-light-grey';
    uploadItem.id = uploadId;

    let previewHtml = '';
    if (existingMedia) {
        previewHtml = `
            <div class="mb-3">
                <img src="${existingMedia.url}" alt="${existingMedia.alt_text || 'Preview'}" class="w-full h-40 object-cover rounded-lg">
                <input type="hidden" class="existing-media-id" value="${existingMedia.id}">
            </div>
        `;
    }

    uploadItem.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <span class="text-sm font-medium text-charcoal">Image ${container.children.length + 1}</span>
            <button type="button" onclick="removeImageUpload('${uploadId}'${existingMedia ? `, ${existingMedia.id}` : ''})" class="text-red-600 hover:text-red-700 transition">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
        ${previewHtml}
        <input type="file"
               class="image-upload-input w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-muted-blue"
               accept=".jpg,.jpeg,.png,.gif,.webp,.svg"
               onchange="previewImage(this, '${uploadId}')">
        <div class="image-preview-container mt-2 hidden">
            <img class="image-preview w-full h-40 object-cover rounded-lg" src="" alt="Preview">
        </div>
    `;

    container.appendChild(uploadItem);
    lucide.createIcons();
}

// Remove an image upload field
function removeImageUpload(uploadId, mediaId = null) {
    if (mediaId) {
        existingMediaToDelete.push(mediaId);
    }
    document.getElementById(uploadId).remove();
    updateImageLabels();
}

// Update image labels after removal
function updateImageLabels() {
    const container = document.getElementById('image-uploads-container');
    const items = container.children;
    for (let i = 0; i < items.length; i++) {
        const label = items[i].querySelector('span');
        if (label) {
            label.textContent = `Image ${i + 1}`;
        }
    }
}

// Preview image when selected
function previewImage(input, uploadId) {
    const uploadItem = document.getElementById(uploadId);
    const previewContainer = uploadItem.querySelector('.image-preview-container');
    const previewImg = uploadItem.querySelector('.image-preview');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Add a new metric row
function addMetricRow(existingMetric = null) {
    const container = document.getElementById('metrics-container');
    const metricId = `metric-${metricCounter++}`;

    const metricRow = document.createElement('div');
    metricRow.className = 'border border-gray-200 rounded-xl p-4 bg-light-grey';
    metricRow.id = metricId;

    const iconType = existingMetric?.icon_type || 'emoji';
    const iconValue = existingMetric?.icon_value || '';
    const metricValue = existingMetric?.metric_value || '';
    const metricLabel = existingMetric?.metric_label || '';

    metricRow.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <span class="text-sm font-medium text-charcoal">Metric ${container.children.length + 1}</span>
            <button type="button" onclick="removeMetricRow('${metricId}'${existingMetric ? `, ${existingMetric.id}` : ''})" class="text-red-600 hover:text-red-700 transition">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
        ${existingMetric ? `<input type="hidden" class="existing-metric-id" value="${existingMetric.id}">` : ''}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Icon Type</label>
                <select class="metric-icon-type w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-muted-blue" onchange="toggleIconInput(this, '${metricId}')">
                    <option value="emoji" ${iconType === 'emoji' ? 'selected' : ''}>Emoji</option>
                    <option value="lucide" ${iconType === 'lucide' ? 'selected' : ''}>Lucide Icon</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Icon</label>
                <input type="text"
                       class="metric-icon-value w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-muted-blue"
                       placeholder="${iconType === 'emoji' ? 'e.g., ⏱' : 'e.g., clock'}"
                       value="${iconValue}">
                <p class="text-xs text-gray-500 mt-1 icon-hint">${iconType === 'emoji' ? 'Paste emoji character' : 'Lucide icon name (e.g., clock, zap)'}</p>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Value</label>
                <input type="text"
                       class="metric-value w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-muted-blue"
                       placeholder="e.g., 6-8 hours"
                       value="${metricValue}">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Label</label>
                <input type="text"
                       class="metric-label w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-muted-blue"
                       placeholder="e.g., saved weekly"
                       value="${metricLabel}">
            </div>
        </div>
    `;

    container.appendChild(metricRow);
    lucide.createIcons();
}

// Toggle icon input placeholder based on type
function toggleIconInput(selectElement, metricId) {
    const metricRow = document.getElementById(metricId);
    const iconInput = metricRow.querySelector('.metric-icon-value');
    const iconHint = metricRow.querySelector('.icon-hint');
    const iconType = selectElement.value;

    if (iconType === 'emoji') {
        iconInput.placeholder = 'e.g., ⏱';
        iconHint.textContent = 'Paste emoji character';
    } else {
        iconInput.placeholder = 'e.g., clock';
        iconHint.textContent = 'Lucide icon name (e.g., clock, zap)';
    }
}

// Remove a metric row
function removeMetricRow(metricId, existingMetricId = null) {
    if (existingMetricId) {
        existingMetricsToDelete.push(existingMetricId);
    }
    document.getElementById(metricId).remove();
    updateMetricLabels();
}

// Update metric labels after removal
function updateMetricLabels() {
    const container = document.getElementById('metrics-container');
    const items = container.children;
    for (let i = 0; i < items.length; i++) {
        const label = items[i].querySelector('span');
        if (label) {
            label.textContent = `Metric ${i + 1}`;
        }
    }
}

async function loadClients() {
    const token = localStorage.getItem('access_token');
    try {
        const response = await fetch('/api/v1/admin/clients', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return;

        const clients = await response.json();
        const select = document.getElementById('client-id');

        // Keep the "No client" option and add clients
        select.innerHTML = '<option value="">No client (personal project)</option>';
        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.company_name || client.contact_name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

async function loadProjects() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/admin/login';
        return;
    }

    try {
        const response = await fetch('/api/v1/admin/projects', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('access_token');
            window.location.href = '/admin/login?error=session_expired';
            return;
        }

        if (!response.ok) throw new Error('Failed to load projects');

        const projects = await response.json();
        displayProjects(projects);
    } catch (error) {
        console.error('Error loading projects:', error);
        document.getElementById('projects-list').innerHTML = `
            <tr><td colspan="5" class="px-6 py-8 text-center text-red-600">Error loading projects</td></tr>
        `;
    }
}

function displayProjects(projects) {
    const tbody = document.getElementById('projects-list');

    if (projects.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No projects yet. Click "Add Project" to create one.</td></tr>
        `;
        return;
    }

    tbody.innerHTML = projects.map(project => `
        <tr class="border-t border-gray-100 hover:bg-light-grey transition">
            <td class="px-6 py-4">
                <p class="font-semibold text-charcoal">${project.title}</p>
            </td>
            <td class="px-6 py-4 text-gray-600">${project.slug}</td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${project.is_published ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                    ${project.is_published ? 'Published' : 'Draft'}
                </span>
            </td>
            <td class="px-6 py-4">
                ${project.is_featured ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Featured</span>' : '-'}
            </td>
            <td class="px-6 py-4 text-gray-600">${project.date ? new Date(project.date).toLocaleDateString() : '-'}</td>
            <td class="px-6 py-4">
                <div class="flex gap-2">
                    <button onclick="editProject(${project.id})" class="p-2 text-muted-blue hover:bg-blue-50 rounded-lg transition" title="Edit">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteProject(${project.id}, '${project.title.replace(/'/g, "\\'")}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    lucide.createIcons();
}

function openProjectModal(project = null) {
    editingProjectId = project ? project.id : null;
    document.getElementById('modal-title').textContent = project ? 'Edit Project' : 'Add Project';
    document.getElementById('project-form').reset();
    quillEditor.root.innerHTML = ''; // Clear Quill editor
    document.getElementById('form-error').classList.add('hidden');

    // Reset image uploads
    const imageContainer = document.getElementById('image-uploads-container');
    imageContainer.innerHTML = '';
    imageUploadCounter = 0;
    existingMediaToDelete = [];

    // Reset metrics
    const metricsContainer = document.getElementById('metrics-container');
    metricsContainer.innerHTML = '';
    metricCounter = 0;
    existingMetricsToDelete = [];

    // Hide current video display
    document.getElementById('current-video').classList.add('hidden');

    if (project) {
        document.getElementById('project-id').value = project.id;
        document.getElementById('client-id').value = project.client_id || '';
        document.getElementById('title').value = project.title;
        document.getElementById('slug').value = project.slug;
        document.getElementById('short-description').value = project.short_description || '';
        quillEditor.root.innerHTML = project.description || ''; // Set Quill editor content
        document.getElementById('description').value = project.description || '';
        document.getElementById('tech-stack').value = project.tech_stack ? project.tech_stack.join(', ') : '';
        document.getElementById('project-url').value = project.project_url || '';
        document.getElementById('is-published').checked = project.is_published;
        document.getElementById('is-featured').checked = project.is_featured || false;

        // Load existing media if available
        if (project.media && project.media.length > 0) {
            const videoMedia = project.media.filter(m => m.media_type === 'video');
            const imageMedia = project.media.filter(m => m.media_type === 'image').sort((a, b) => a.display_order - b.display_order);

            // Show video if exists
            if (videoMedia.length > 0) {
                document.getElementById('current-video').classList.remove('hidden');
                document.getElementById('current-video-name').textContent = videoMedia[0].url.split('/').pop();
            }

            // Add existing images
            imageMedia.forEach(media => {
                addImageUpload(media);
            });
        }

        // Add one empty upload field if no images exist
        if (!project.media || project.media.filter(m => m.media_type === 'image').length === 0) {
            addImageUpload();
        }

        // Load existing metrics if available
        if (project.metrics && project.metrics.length > 0) {
            project.metrics.sort((a, b) => a.display_order - b.display_order).forEach(metric => {
                addMetricRow(metric);
            });
        }
    } else {
        // For new projects, add one empty upload field
        addImageUpload();
    }

    document.getElementById('project-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeProjectModal() {
    document.getElementById('project-modal').classList.add('hidden');
    editingProjectId = null;
}

async function editProject(projectId) {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch(`/api/v1/admin/projects/${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load project');

        const project = await response.json();
        openProjectModal(project);
    } catch (error) {
        console.error('Error loading project:', error);
        alert('Failed to load project details');
    }
}

async function deleteProject(projectId, projectTitle) {
    if (!confirm(`Are you sure you want to delete "${projectTitle}"? This cannot be undone.`)) {
        return;
    }

    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch(`/api/v1/admin/projects/${projectId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete project');

        await loadProjects();
    } catch (error) {
        console.error('Error deleting project:', error);
        alert('Failed to delete project');
    }
}

async function saveProjectMetrics(projectId) {
    const token = localStorage.getItem('access_token');

    // Delete metrics that were marked for deletion
    for (const metricId of existingMetricsToDelete) {
        try {
            const response = await fetch(`/api/v1/admin/projects/metrics/${metricId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error(`Failed to delete metric ${metricId}`);
            }
        } catch (error) {
            console.error(`Error deleting metric ${metricId}:`, error);
        }
    }

    // Get all metric rows
    const metricRows = document.querySelectorAll('#metrics-container > div');

    for (let i = 0; i < metricRows.length; i++) {
        const row = metricRows[i];
        const existingMetricId = row.querySelector('.existing-metric-id')?.value;
        const iconType = row.querySelector('.metric-icon-type').value;
        const iconValue = row.querySelector('.metric-icon-value').value.trim();
        const metricValue = row.querySelector('.metric-value').value.trim();
        const metricLabel = row.querySelector('.metric-label').value.trim();

        // Skip if all fields are empty
        if (!iconValue && !metricValue && !metricLabel) continue;

        const metricData = {
            icon_type: iconType,
            icon_value: iconValue,
            metric_value: metricValue,
            metric_label: metricLabel,
            display_order: i
        };

        try {
            if (existingMetricId) {
                // Update existing metric
                const response = await fetch(`/api/v1/admin/projects/metrics/${existingMetricId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metricData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Failed to update metric ${i + 1}`);
                }
            } else {
                // Create new metric
                const response = await fetch(`/api/v1/admin/projects/${projectId}/metrics`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metricData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Failed to create metric ${i + 1}`);
                }
            }
        } catch (error) {
            console.error(`Error saving metric ${i + 1}:`, error);
            throw error;
        }
    }
}

async function uploadProjectMedia(projectId) {
    const token = localStorage.getItem('access_token');

    // Delete media that was marked for deletion
    for (const mediaId of existingMediaToDelete) {
        try {
            const response = await fetch(`/api/v1/admin/projects/media/${mediaId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error(`Failed to delete media ${mediaId}`);
            }
        } catch (error) {
            console.error(`Error deleting media ${mediaId}:`, error);
        }
    }

    // Upload video if selected
    const videoInput = document.getElementById('video-file');
    if (videoInput.files[0]) {
        const formData = new FormData();
        formData.append('file', videoInput.files[0]);
        formData.append('alt_text', '');
        formData.append('display_order', '0');

        try {
            const response = await fetch(`/api/v1/admin/projects/${projectId}/media`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to upload video');
            }
        } catch (error) {
            console.error('Error uploading video:', error);
            throw error;
        }
    }

    // Upload all new images
    const imageInputs = document.querySelectorAll('.image-upload-input');
    for (let i = 0; i < imageInputs.length; i++) {
        const input = imageInputs[i];
        const file = input.files[0];

        if (!file) continue; // Skip if no new file selected

        const formData = new FormData();
        formData.append('file', file);
        formData.append('alt_text', '');
        formData.append('display_order', i.toString());

        try {
            const response = await fetch(`/api/v1/admin/projects/${projectId}/media`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || `Failed to upload image ${i + 1}`);
            }

            console.log(`Successfully uploaded image ${i + 1}`);
        } catch (error) {
            console.error(`Error uploading image ${i + 1}:`, error);
            throw error;
        }
    }
}

document.getElementById('project-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const errorDiv = document.getElementById('form-error');
    errorDiv.classList.add('hidden');

    const clientId = document.getElementById('client-id').value;
    const shortDesc = document.getElementById('short-description').value;
    const projectData = {
        client_id: clientId ? parseInt(clientId) : null,
        title: document.getElementById('title').value,
        short_description: shortDesc || null,
        description: document.getElementById('description').value,
        tech_stack: document.getElementById('tech-stack').value.split(',').map(t => t.trim()).filter(t => t),
        project_url: document.getElementById('project-url').value || null,
        is_published: document.getElementById('is-published').checked,
        is_featured: document.getElementById('is-featured').checked
    };

    console.log('=== PROJECT DATA BEING SENT ===');
    console.log('is_featured checkbox value:', document.getElementById('is-featured').checked);
    console.log('Full project data:', JSON.stringify(projectData, null, 2));

    const token = localStorage.getItem('access_token');
    const url = editingProjectId
        ? `/api/v1/admin/projects/${editingProjectId}`
        : '/api/v1/admin/projects';
    const method = editingProjectId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(projectData)
        });

        if (!response.ok) {
            const error = await response.json();
            console.error('=== SERVER ERROR ===', error);
            throw new Error(error.detail || 'Failed to save project');
        }

        const savedProject = await response.json();
        console.log('=== PROJECT SAVED SUCCESSFULLY ===');
        console.log('Saved project is_featured:', savedProject.is_featured);
        console.log('Full saved project:', savedProject);

        // Save metrics first (no file dependencies)
        await saveProjectMetrics(savedProject.id);

        // Upload media files
        await uploadProjectMedia(savedProject.id);

        closeProjectModal();
        await loadProjects();
    } catch (error) {
        console.error('Error saving project:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    }
});

// Auto-generate slug from title
document.getElementById('title').addEventListener('input', (e) => {
    if (!editingProjectId) {
        const slug = e.target.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        document.getElementById('slug').value = slug;
    }
});

// Load projects and clients on page load
loadProjects();
loadClients();
</script>
{% endblock %}

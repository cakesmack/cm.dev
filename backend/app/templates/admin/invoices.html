{% extends "admin/base.html" %}

{% block title %}Invoices{% endblock %}

{% block content %}
<div class="md:mt-0 mt-16">
    <div class="fade-in mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold text-charcoal">Invoices</h1>
            <p class="text-gray-600 mt-2">Manage client invoices and payments</p>
        </div>
        <button onclick="openInvoiceModal()" class="flex items-center gap-2 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>Create Invoice</span>
        </button>
    </div>

    <!-- Stats -->
    <div class="grid md:grid-cols-5 gap-6 mb-8">
        <div class="fade-in bg-white p-6 rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-gray-600">Draft</p>
                <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="file-edit" class="w-4 h-4 text-gray-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-charcoal" id="draft-count">-</p>
        </div>

        <div class="fade-in bg-white p-6 rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-gray-600">Sent</p>
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="send" class="w-4 h-4 text-blue-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-charcoal" id="sent-count">-</p>
        </div>

        <div class="fade-in bg-white p-6 rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-gray-600">Paid</p>
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-charcoal" id="paid-count">-</p>
        </div>

        <div class="fade-in bg-white p-6 rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-gray-600">Overdue</p>
                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-charcoal" id="overdue-count">-</p>
        </div>

        <div class="fade-in bg-white p-6 rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-gray-600">Cancelled</p>
                <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="x-circle" class="w-4 h-4 text-gray-600"></i>
                </div>
            </div>
            <p class="text-2xl font-bold text-charcoal" id="cancelled-count">-</p>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="fade-in bg-white rounded-2xl shadow-sm overflow-hidden">
        <div id="invoices-table" class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-light-grey">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Invoice #</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Client</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Amount</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Status</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Issue Date</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Due Date</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-charcoal">Actions</th>
                    </tr>
                </thead>
                <tbody id="invoices-list">
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">Loading invoices...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Invoice Detail Modal -->
<div id="invoice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6 no-print-overlay">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6 no-print">
                <h2 class="text-2xl font-bold text-charcoal">Invoice Details</h2>
                <button onclick="closeInvoiceModal()" class="text-gray-500 hover:text-charcoal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="invoice-details" class="space-y-6 print-invoice">
                <!-- Invoice details will be populated here -->
            </div>

            <div class="mt-8 flex gap-4 no-print">
                <button id="edit-invoice-btn" onclick="openEditInvoiceModal()" class="flex-1 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                    <i data-lucide="edit" class="w-5 h-5 inline-block mr-2"></i>
                    Edit Invoice
                </button>
                <button id="print-invoice-btn" onclick="printInvoice()" class="flex-1 bg-muted-blue text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                    <i data-lucide="printer" class="w-5 h-5 inline-block mr-2"></i>
                    Print Invoice
                </button>
                <button onclick="closeInvoiceModal()" class="flex-1 px-6 py-3 border-2 border-gray-200 rounded-xl font-medium hover:border-muted-blue transition">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Creation Modal -->
<div id="create-invoice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-charcoal">Create Invoice</h2>
                <button onclick="closeCreateInvoiceModal()" class="text-gray-500 hover:text-charcoal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="invoice-form" class="space-y-6">
                <!-- Client Selection -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Client *</label>
                    <select id="client-select" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                        <option value="">Select a client</option>
                    </select>
                </div>

                <!-- Project Selection (Optional) -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Project (Optional)</label>
                    <select id="project-select" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                        <option value="">No project</option>
                    </select>
                </div>

                <!-- Due Date -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-charcoal mb-2">Due Date</label>
                        <input type="date" id="due-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-charcoal mb-2">Tax Rate (%)</label>
                        <input type="number" id="tax-rate" value="0" min="0" max="100" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                    </div>
                </div>

                <!-- Line Items -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-charcoal">Line Items *</label>
                        <button type="button" onclick="addLineItem()" class="flex items-center gap-2 text-muted-blue hover:text-blue-700 font-medium">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            <span>Add Item</span>
                        </button>
                    </div>
                    <div id="line-items-container" class="space-y-3">
                        <!-- Line items will be added here -->
                    </div>
                </div>

                <!-- Totals Display -->
                <div class="border-t pt-6 space-y-2">
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span id="subtotal-display" class="font-semibold">$0.00</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span>Tax:</span>
                        <span id="tax-display" class="font-semibold">$0.00</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-charcoal border-t pt-2">
                        <span>Total:</span>
                        <span id="total-display">$0.00</span>
                    </div>
                </div>

                <!-- Notes and Terms -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-charcoal mb-2">Notes</label>
                        <textarea id="notes" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-charcoal mb-2">Terms</label>
                        <textarea id="terms" rows="3" placeholder="Payment terms..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue resize-none"></textarea>
                    </div>
                </div>

                <div id="form-error" class="hidden p-4 bg-red-50 text-red-800 border border-red-200 rounded-xl text-sm"></div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                        Create Invoice
                    </button>
                    <button type="button" onclick="closeCreateInvoiceModal()" class="px-6 py-3 border-2 border-gray-200 rounded-xl font-medium hover:border-muted-blue transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Invoice Modal -->
<div id="edit-invoice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-charcoal">Edit Invoice</h2>
                <button onclick="closeEditInvoiceModal()" class="text-gray-500 hover:text-charcoal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="edit-invoice-form" class="space-y-6">
                <!-- Due Date -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Due Date</label>
                    <input type="date" id="edit-due-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                </div>

                <!-- Tax Rate -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Tax Rate (%)</label>
                    <input type="number" id="edit-tax-rate" min="0" max="100" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Notes</label>
                    <textarea id="edit-notes" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue resize-none"></textarea>
                </div>

                <!-- Terms -->
                <div>
                    <label class="block text-sm font-medium text-charcoal mb-2">Payment Terms</label>
                    <textarea id="edit-terms" rows="3" placeholder="Payment terms..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue resize-none"></textarea>
                </div>

                <div id="edit-form-error" class="hidden p-4 bg-red-50 text-red-800 border border-red-200 rounded-xl text-sm"></div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-charcoal text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditInvoiceModal()" class="px-6 py-3 border-2 border-gray-200 rounded-xl font-medium hover:border-muted-blue transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Print Styles for Professional Invoice PDF */
@media print {
    /* Hide everything on the page */
    body * {
        visibility: hidden;
    }

    /* Show only the invoice modal and its contents */
    #invoice-modal,
    #invoice-modal * {
        visibility: visible;
    }

    /* Hide modal UI elements */
    #invoice-modal .no-print,
    #invoice-modal .no-print * {
        visibility: hidden;
        display: none;
    }

    /* Position invoice modal for printing */
    #invoice-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
        display: block !important;
    }

    #invoice-modal > div {
        max-width: 100% !important;
        max-height: none !important;
        overflow: visible !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 40px !important;
    }

    /* Reset page styling */
    body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Format invoice content */
    .print-invoice {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Professional typography */
    h1, h2, h3 {
        color: #1A1A1A !important;
    }

    /* Ensure proper page breaks */
    table {
        page-break-inside: auto;
    }

    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    /* Remove status badge background for print */
    .status-badge {
        background: transparent !important;
        border: 1px solid #1A1A1A !important;
        color: #1A1A1A !important;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let allInvoices = [];
let allClients = [];
let allProjects = [];
let currentInvoiceId = null;

async function loadClientsAndProjects() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        // Load clients
        const clientsResponse = await fetch('/api/v1/admin/clients', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (clientsResponse.ok) {
            allClients = await clientsResponse.json();
        }

        // Load projects
        const projectsResponse = await fetch('/api/v1/admin/projects', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (projectsResponse.ok) {
            allProjects = await projectsResponse.json();
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

async function loadInvoices() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/admin/login';
        return;
    }

    try {
        const response = await fetch('/api/v1/admin/invoices', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('access_token');
            window.location.href = '/admin/login?error=session_expired';
            return;
        }

        if (!response.ok) throw new Error('Failed to load invoices');

        allInvoices = await response.json();
        updateStats();
        displayInvoices(allInvoices);
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('invoices-list').innerHTML = `
            <tr><td colspan="7" class="px-6 py-8 text-center text-red-600">Error loading invoices</td></tr>
        `;
    }
}

function updateStats() {
    const stats = {
        draft: 0,
        sent: 0,
        paid: 0,
        overdue: 0,
        cancelled: 0
    };

    allInvoices.forEach(invoice => {
        stats[invoice.status]++;
    });

    document.getElementById('draft-count').textContent = stats.draft;
    document.getElementById('sent-count').textContent = stats.sent;
    document.getElementById('paid-count').textContent = stats.paid;
    document.getElementById('overdue-count').textContent = stats.overdue;
    document.getElementById('cancelled-count').textContent = stats.cancelled;
}

function displayInvoices(invoices) {
    const tbody = document.getElementById('invoices-list');

    if (invoices.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No invoices yet</td></tr>
        `;
        return;
    }

    const statusColors = {
        draft: 'bg-gray-100 text-gray-700',
        sent: 'bg-blue-100 text-blue-700',
        paid: 'bg-green-100 text-green-700',
        overdue: 'bg-red-100 text-red-700',
        cancelled: 'bg-gray-100 text-gray-700'
    };

    tbody.innerHTML = invoices.map(invoice => `
        <tr class="border-t border-gray-100 hover:bg-light-grey transition cursor-pointer" onclick="viewInvoice(${invoice.id})">
            <td class="px-6 py-4 font-semibold text-charcoal">${invoice.invoice_number}</td>
            <td class="px-6 py-4 text-gray-600">${invoice.client ? (invoice.client.company_name || invoice.client.contact_name) : '-'}</td>
            <td class="px-6 py-4 font-semibold text-charcoal">$${parseFloat(invoice.total || 0).toFixed(2)}</td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[invoice.status]}">
                    ${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                </span>
            </td>
            <td class="px-6 py-4 text-gray-600">${new Date(invoice.issue_date).toLocaleDateString()}</td>
            <td class="px-6 py-4 text-gray-600">${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : '-'}</td>
            <td class="px-6 py-4" onclick="event.stopPropagation()">
                <div class="flex gap-2">
                    <button onclick="deleteInvoice(${invoice.id}, '${invoice.invoice_number}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    lucide.createIcons();
}

async function viewInvoice(invoiceId) {
    const invoice = allInvoices.find(i => i.id === invoiceId);
    if (!invoice) return;

    currentInvoiceId = invoiceId;

    const statusColors = {
        draft: 'bg-gray-100 text-gray-700',
        sent: 'bg-blue-100 text-blue-700',
        paid: 'bg-green-100 text-green-700',
        overdue: 'bg-red-100 text-red-700',
        cancelled: 'bg-gray-100 text-gray-700'
    };

    const formatDate = (dateString) => {
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };

    document.getElementById('invoice-details').innerHTML = `
        <!-- Header with Invoice Number and Company Info -->
        <div class="flex justify-between items-start mb-12">
            <div>
                <h1 class="text-5xl font-bold text-charcoal mb-3">INVOICE</h1>
                <p class="text-2xl font-semibold text-gray-700">${invoice.invoice_number}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-medium text-gray-700">Craig Mackenzie</p>
                <p class="text-sm text-gray-600">United Kingdom</p>
            </div>
        </div>

        <!-- Status Badge and Dates -->
        <div class="flex justify-between items-center mb-12 pb-6 border-b-2 border-gray-200">
            <div>
                <span class="text-sm px-4 py-2 rounded-full capitalize font-medium status-badge ${statusColors[invoice.status]}">
                    ${invoice.status}
                </span>
            </div>
            <div class="text-right space-y-2">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Invoice Date</p>
                    <p class="text-lg font-semibold text-charcoal">${formatDate(invoice.issue_date)}</p>
                </div>
                ${invoice.due_date ? `
                <div>
                    <p class="text-sm text-gray-600 font-medium">Due Date</p>
                    <p class="text-lg font-semibold text-charcoal">${formatDate(invoice.due_date)}</p>
                </div>
                ` : ''}
            </div>
        </div>

        <!-- Billing Information -->
        <div class="grid grid-cols-2 gap-12 mb-12">
            <div>
                <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3">Billed From</h3>
                <div class="space-y-1">
                    <p class="text-lg font-semibold text-charcoal">Craig Mackenzie</p>
                    <p class="text-gray-700">United Kingdom</p>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3">Billed To</h3>
                <div class="space-y-1">
                    <p class="text-lg font-semibold text-charcoal">${invoice.client ? (invoice.client.company_name || invoice.client.contact_name) : 'N/A'}</p>
                    ${invoice.client?.contact_email ? `<p class="text-gray-600">${invoice.client.contact_email}</p>` : ''}
                    ${invoice.client?.address || invoice.client?.city || invoice.client?.postcode ? `
                    <p class="text-gray-600 mt-2">
                        ${[invoice.client.address, invoice.client.city, invoice.client.postcode].filter(Boolean).join(', ')}
                    </p>
                    ` : ''}
                </div>
            </div>
        </div>

        <!-- Line Items Table -->
        <div class="mb-12">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-4 text-sm font-bold text-gray-700 uppercase tracking-wide">Description</th>
                        <th class="text-right py-4 text-sm font-bold text-gray-700 uppercase tracking-wide w-24">Qty</th>
                        <th class="text-right py-4 text-sm font-bold text-gray-700 uppercase tracking-wide w-32">Rate</th>
                        <th class="text-right py-4 text-sm font-bold text-gray-700 uppercase tracking-wide w-32">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items?.map(item => `
                        <tr class="border-b border-gray-200">
                            <td class="py-5 text-charcoal font-medium">${item.description}</td>
                            <td class="py-5 text-right text-gray-600">${item.quantity}</td>
                            <td class="py-5 text-right text-gray-600">£${parseFloat(item.unit_price).toFixed(2)}</td>
                            <td class="py-5 text-right font-semibold text-charcoal">
                                £${(item.quantity * item.unit_price).toFixed(2)}
                            </td>
                        </tr>
                    `).join('') || ''}
                </tbody>
            </table>
        </div>

        <!-- Totals -->
        <div class="flex justify-end mb-12">
            <div class="w-80">
                <div class="flex justify-between py-3 border-b border-gray-200">
                    <span class="text-gray-700 font-medium">Subtotal</span>
                    <span class="font-semibold text-charcoal text-lg">£${parseFloat(invoice.subtotal || 0).toFixed(2)}</span>
                </div>
                ${invoice.tax_rate > 0 ? `
                <div class="flex justify-between py-3 border-b border-gray-200">
                    <span class="text-gray-700 font-medium">VAT (${parseFloat(invoice.tax_rate)}%)</span>
                    <span class="font-semibold text-charcoal text-lg">£${parseFloat(invoice.tax_amount || 0).toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="flex justify-between py-4 bg-gray-50 px-4 rounded-lg mt-3">
                    <span class="text-xl font-bold text-charcoal">Total</span>
                    <span class="text-2xl font-bold text-charcoal">£${parseFloat(invoice.total || 0).toFixed(2)}</span>
                </div>
            </div>
        </div>

        <!-- Notes and Terms -->
        <div class="space-y-6">
            ${invoice.notes ? `
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3">Notes</h3>
                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${invoice.notes}</p>
            </div>
            ` : ''}
            ${invoice.terms ? `
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3">Terms & Conditions</h3>
                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${invoice.terms}</p>
            </div>
            ` : ''}
        </div>

        <!-- Footer -->
        <div class="mt-12 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
            <p>Thank you for your business!</p>
        </div>
    `;

    document.getElementById('invoice-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeInvoiceModal() {
    document.getElementById('invoice-modal').classList.add('hidden');
}

function printInvoice() {
    window.print();
}

async function updateInvoiceStatus(invoiceId, newStatus) {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch(`/api/v1/admin/invoices/${invoiceId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) throw new Error('Failed to update status');

        await loadInvoices();
        closeInvoiceModal();
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update invoice status');
    }
}

function openEditInvoiceModal() {
    if (!currentInvoiceId) return;

    const invoice = allInvoices.find(i => i.id === currentInvoiceId);
    if (!invoice) return;

    // Populate form with current values
    document.getElementById('edit-due-date').value = invoice.due_date ? invoice.due_date.split('T')[0] : '';
    document.getElementById('edit-tax-rate').value = invoice.tax_rate || 0;
    document.getElementById('edit-notes').value = invoice.notes || '';
    document.getElementById('edit-terms').value = invoice.terms || '';

    // Hide error message
    document.getElementById('edit-form-error').classList.add('hidden');

    // Show edit modal
    document.getElementById('edit-invoice-modal').classList.remove('hidden');
}

function closeEditInvoiceModal() {
    document.getElementById('edit-invoice-modal').classList.add('hidden');
}

let lineItemCount = 0;

function addLineItem() {
    lineItemCount++;
    const container = document.getElementById('line-items-container');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'flex gap-3 items-start';
    itemDiv.id = `line-item-${lineItemCount}`;
    itemDiv.innerHTML = `
        <div class="flex-1">
            <input type="text"
                   data-item-id="${lineItemCount}"
                   data-field="description"
                   placeholder="Description"
                   required
                   class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
        </div>
        <div class="w-24">
            <input type="number"
                   data-item-id="${lineItemCount}"
                   data-field="quantity"
                   placeholder="Qty"
                   min="0.01"
                   step="0.01"
                   value="1"
                   required
                   oninput="updateTotals()"
                   class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
        </div>
        <div class="w-32">
            <input type="number"
                   data-item-id="${lineItemCount}"
                   data-field="unit_price"
                   placeholder="Price"
                   min="0"
                   step="0.01"
                   value="0"
                   required
                   oninput="updateTotals()"
                   class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-muted-blue">
        </div>
        <button type="button"
                onclick="removeLineItem(${lineItemCount})"
                class="p-3 text-red-600 hover:bg-red-50 rounded-xl transition">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
    `;
    container.appendChild(itemDiv);
    lucide.createIcons();
}

function removeLineItem(itemId) {
    const item = document.getElementById(`line-item-${itemId}`);
    if (item) {
        item.remove();
        updateTotals();
    }

    // Ensure at least one line item
    const container = document.getElementById('line-items-container');
    if (container.children.length === 0) {
        addLineItem();
    }
}

function updateTotals() {
    const container = document.getElementById('line-items-container');
    const items = container.querySelectorAll('[data-field="quantity"]');

    let subtotal = 0;
    items.forEach(qtyInput => {
        const itemId = qtyInput.dataset.itemId;
        const priceInput = container.querySelector(`[data-item-id="${itemId}"][data-field="unit_price"]`);

        const quantity = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        subtotal += quantity * price;
    });

    const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;
    const taxAmount = (subtotal * taxRate) / 100;
    const total = subtotal + taxAmount;

    document.getElementById('subtotal-display').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('tax-display').textContent = `$${taxAmount.toFixed(2)}`;
    document.getElementById('total-display').textContent = `$${total.toFixed(2)}`;
}

function openInvoiceModal() {
    // Populate client dropdown
    const clientSelect = document.getElementById('client-select');
    clientSelect.innerHTML = '<option value="">Select a client</option>';
    allClients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.company_name || client.contact_name;
        clientSelect.appendChild(option);
    });

    // Populate project dropdown
    const projectSelect = document.getElementById('project-select');
    projectSelect.innerHTML = '<option value="">No project</option>';
    allProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.title;
        projectSelect.appendChild(option);
    });

    // Add initial line item
    document.getElementById('line-items-container').innerHTML = '';
    addLineItem();

    // Reset form
    document.getElementById('invoice-form').reset();
    document.getElementById('form-error').classList.add('hidden');

    // Add tax rate listener
    document.getElementById('tax-rate').addEventListener('input', updateTotals);

    updateTotals();

    // Show modal
    document.getElementById('create-invoice-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeCreateInvoiceModal() {
    document.getElementById('create-invoice-modal').classList.add('hidden');
}

async function deleteInvoice(invoiceId, invoiceNumber) {
    if (!confirm(`Are you sure you want to delete invoice "${invoiceNumber}"?`)) {
        return;
    }

    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch(`/api/v1/admin/invoices/${invoiceId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete invoice');

        await loadInvoices();
    } catch (error) {
        console.error('Error deleting invoice:', error);
        alert('Failed to delete invoice');
    }
}

document.getElementById('invoice-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const errorDiv = document.getElementById('form-error');
    errorDiv.classList.add('hidden');

    // Gather line items
    const container = document.getElementById('line-items-container');
    const itemElements = container.querySelectorAll('[data-field="description"]');
    const items = [];

    for (const descInput of itemElements) {
        const itemId = descInput.dataset.itemId;
        const qtyInput = container.querySelector(`[data-item-id="${itemId}"][data-field="quantity"]`);
        const priceInput = container.querySelector(`[data-item-id="${itemId}"][data-field="unit_price"]`);

        const description = descInput.value.trim();
        const quantity = parseFloat(qtyInput.value);
        const unit_price = parseFloat(priceInput.value);

        if (description && quantity > 0) {
            items.push({ description, quantity, unit_price });
        }
    }

    if (items.length === 0) {
        errorDiv.textContent = 'Please add at least one line item';
        errorDiv.classList.remove('hidden');
        return;
    }

    // Build invoice data
    const invoiceData = {
        client_id: parseInt(document.getElementById('client-select').value),
        project_id: document.getElementById('project-select').value ?
                    parseInt(document.getElementById('project-select').value) : null,
        due_date: document.getElementById('due-date').value || null,
        tax_rate: parseFloat(document.getElementById('tax-rate').value) || 0,
        notes: document.getElementById('notes').value || null,
        terms: document.getElementById('terms').value || null,
        items: items
    };

    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/v1/admin/invoices', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(invoiceData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create invoice');
        }

        closeCreateInvoiceModal();
        await loadInvoices();

        // Show success message
        alert('Invoice created successfully!');
    } catch (error) {
        console.error('Error creating invoice:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    }
});

// Edit invoice form handler
document.getElementById('edit-invoice-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentInvoiceId) return;

    const errorDiv = document.getElementById('edit-form-error');
    errorDiv.classList.add('hidden');

    // Build update data
    const updateData = {
        due_date: document.getElementById('edit-due-date').value || null,
        tax_rate: parseFloat(document.getElementById('edit-tax-rate').value) || 0,
        notes: document.getElementById('edit-notes').value || null,
        terms: document.getElementById('edit-terms').value || null
    };

    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch(`/api/v1/admin/invoices/${currentInvoiceId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update invoice');
        }

        closeEditInvoiceModal();
        closeInvoiceModal();
        await loadInvoices();

        alert('Invoice updated successfully!');
    } catch (error) {
        console.error('Error updating invoice:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    }
});

// Load all data on page load
loadInvoices();
loadClientsAndProjects();
</script>
{% endblock %}
